## 1 数据库设计

博客系统共涉及5个表。

博客表：t_blog

| 属性        | 说明                 |
| ----------- | -------------------- |
| id          | 主键                 |
| title       | 标题                 |
| summary     | 摘要                 |
| releaseDate | 发布日期             |
| clickHit    | 点击数               |
| replyHit    | 评论数               |
| content     | 内容                 |
| typeId      | 所属博客类型（外键） |
| keyWord     | 关键字               |

博客类型表：t_blogtype

| 属性     | 说明     |
| -------- | -------- |
| id       | 主键     |
| typeName | 类型名称 |
| orderNo  | 序号     |

博主表：t_blogger

| 属性      | 说明     |
| --------- | -------- |
| id        | 主键     |
| userName  | 用户名   |
| password  | 密码     |
| profile   | 个人简介 |
| nickName  | 昵称     |
| sign      | 个性签名 |
| imageName | 头像名   |

评论表：t_comment

| 属性        | 说明                                      |
| ----------- | ----------------------------------------- |
| id          | 主键                                      |
| userIp      | 评论者IP                                  |
| blogId      | 评论博客ID（外键）                        |
| content     | 评论内容                                  |
| commentDate | 评论时间                                  |
| state       | 评论状态（0未审核/1审核通过/2审核不通过） |

友情链接表：t_link

| 属性     | 说明     |
| -------- | -------- |
| id       | 主键     |
| linkName | 链接名称 |
| linkUrl  | 链接地址 |
| orderNo  | 序号     |

## 2 配置环境

### 2.1 配置 web.xml

- 配置项目名为Blog，地址栏访问需要
- 配置项目起始页面，先到a.jsp，在a.jsp中重定向到 index.html
- 配置Shiro过滤器
- 配置spring的配置文件applicationContext.xml
- 配置中文编码过滤器
- 配置spring监听器InitComponent
- 添加对SpringMVC的支持，声明配置文件spring-mvc.xml

### 2.2 配置 applicationContext.xml

- 配置数据源，也就是用于连接数据库的信息（url、username、password）
- 配置MyBatis的sqlSessionFactory
- 配置spring要扫描的dao接口所在的包
- 添加事务管理
- 添加shiro的安全管理器和过滤器
- 开启shiro注解
- 配置事务通知和切面
- 配置自动扫描注解的service包

### 2.3 配置 spring-mvc.xml

- 开启注解
- 配置视图解析器
- 配置要扫描注解的controller包

### 2.4 添加 log4j.properties

在resources中添加log4j.properties文件

## 3 博主后台登陆

### 3.1 MD5加密用户密码

创建 CryptographyUtil 工具类将用户密码进行MD5加密，数据库中保存的是加密后的密码。

### 3.2 博主登陆-login.jsp

- 提示输入用户名和密码，首先验证是否存在输入，没有输入则弹出提示信息。
- 点击提交后，调用 BloggerController 的 login方法。
- 验证成功后 失败提示错误信息。
- 验证失败后会将输入返回给jsp页面，用来填充输入框，避免重新输入。

### 3.3 博主类-Blogger

代表博主实体类，属性和数据库表中的属性保持一致。

### 3.4 博主登陆-BloggerController

- 定义login方法用户验证用户名和密码。
- 首先获取到前台form传入的blogger对象的用户名和密码，并加密。
- 使用shiro验证用户名和密码，传递token给shiro的realm，自定义了MyRealm实现类。
- 如果成功则跳转到后台主界面，否则将错误信息传回给前台页面。

### 3.5 博主信息验证-MyRealm

在MyRealm中首先取得token中传递的用户名和密码，然后调用bloggerservice查询博主信息进行验证。

同时把代表当前登陆的博主实体类blogger放入session中方便其他地方取得。

## 4 博客类别管理

### 4.1 博客类别实体类-BlogType

代表保存的博客类别，属性和数据库表中的保持一致。

特别添加 blogCount 属性，代表该博客类型下博客的数量。

### 4.2 博客类别Dao-BlogTypeDao

定义操作博客类别的方法：

```java
/**无参数查询所有博客类型列表*/
public List<BlogType> countList();

/**根据id查询一条博客类型*/
public BlogType findById(Integer id);

/**不固定参数查询博客类型列表*/
public List<BlogType> list(Map<String,Object> paramMap);

/**不固定参数查询博客类型数*/
public Long getTotal(Map<String,Object> paramMap);

/**添加一条博客类型*/
public Integer add(BlogType blogType);

/**修改一条博客类型*/
public Integer update(BlogType blogType);

/**删除一条博客类型*/
public Integer delete(Integer id);	
```

### 4.3 博客类别Mapper-BlogTypeMapper

采用注解的方式配置dao的方法，在mapper中定义要执行的sql语句。

### 4.3 博客类别Service-BlogTypeService

定义BlogTypeService接口以及实现类BlogTypeServiceImpl

在实现类中添加dao层的引用blogTypeDao，并使用注解赋值。

方法和blogTypeDao保持一致，并且直接调用blogTypedao中的相应方法即可。

### 4.4 博客类别Controller-BlogTypeAdminController

controller中添加service层的引用blogTypeService。

还要添加blogService用来查询某个博客类型下博客的数量。

**1 显示博客列表 list**

根据前台传入的翻页参数（查询第几页和每页显示的条数）调用blogTypeService的list方法查询博客类型列表。

同时调用getTotal方法查询博客数量，最后把列表转化为json格式写入到response中。

**2 保存博客类别 save**

涉及到前台的添加和修改功能。

当传入的blogType没有id代表是添加操作，调用blogTypeService的add方法；有id代表是修改操作，调用blogTypeService的update方法。

最后把是否成功转化为json写入到response中。

**3 删除博客类型 delete**

前台传入的是要删除的类型的id数组，遍历id数组进行删除。

注意：针对每条博客类型，先调用blogService的getBlogByTypeId方法查询要删除的类型下是否存在博客，如果存在表示不能删除，否则删除成功。

将结果转为json并写入response中。

### 4.5 博客类别界面-blogTypeManager.jsp

首先引入jquery的css和js资源。

界面主要分为以下几部分：

- 显示博客类别列表，显示博客类别的id、名称和序号。
- 添加、修改和删除按钮
- 添加类型需要弹出对话框

**1 查询**

当进入博客类别管理界面就进行查询并显示出来，调用的是BlogTypeAdminController中的list方法。

**2 添加**

点击添加按钮，首先弹出博客类别信息对话框，要求输入博客类别名称和序号。

点击保存按钮会调用BlogTypeAdminController的save方法进行插入。同时会返回是否成功的信息。

前台根据返回的值提示用户保存是否成功。

**3 修改**

首先点击一条要修改的数据，然后点击修改按钮，弹出和添加一样的对话框，只不过输入框中填充好了点击的那条数据的信息，在此基础上修改，同样调用的是BlogTypeAdminController的save方法，但是传递id参数代表修改。

前台根据返回的值提示用户保存是否成功。

**4 删除**

用户选择多条类别，然后点击删除按钮。将要删除数据的id拼接成字符串作为参数，调用BlogTypeAdminController的delete方法。如果要删除的博客类别下有博客则会删除失败。

前台根据返回的值提示用户保存是否成功。

## 5 博客管理

### 5.1 博客实体类-Blog

代表保存的博客，属性和数据库中保持一致。

添加额外的属性：

- String contentNoTag，代表纯文本格式的内容（去除了标签元素）
- String releaseDateStr，代表博客发布的时间，用字符串形式表示
- Integer blogCount，代表按照日期分组时，每组的博客数量。

### 5.2 博客Dao-BlogDao

定义操作博客的方法：

```java
/**无参数查询博客列表(供首页使用)*/
public List<Blog> countList();

/**带参数查询博客列表*/
public List<Blog> list(Map<String,Object> map);

/**带参数查询博客数量*/
public Long getTotal(Map<String,Object> map);

/**根据主键查询一条博客信息*/
public Blog findById(Integer id);

/**添加一条博客*/
public Integer add(Blog blog);

/**修改一条博客*/
public Integer update(Blog blog);

/**根据主键删除一条博客*/
public Integer delete(Integer id);

/**根据类型查询博客数量*/
public Integer getBlogByTypeId(Integer typeId);

/**上一篇*/
public Blog getLastBlog(Integer id);

/**下一篇*/
public Blog getNextBlog(Integer id);
```

### 5.3 博客Mapper-BlogMapper

采用注解的方式配置dao的方法，在mapper中定义要执行的sql语句。

注意：countList方法查询博客按照日期分组，统计数量并降序排序。

### 5.4 博客Service-BlogService

定义BlogService接口以及实现类BlogServiceImpl

在实现类中添加dao层的引用blogDao，并使用注解赋值。

方法和blogDao保持一致，并且直接调用blogdao中的相应方法即可。

注意：当删除某个博客时，需要删除博客下的所有评论。

### 5.5 博客Controller-BlogAdminController

controller中添加service层的引用blogService。

还要添加blogIndex用来供主页来查询博客，lucene索引。

**1 保存博客 save**

根据传入的blog是否具有id代表添加或者更新，当没有id时代表添加操作，调用blogService的add方法。

当有id时代表修改操作，调用blogService的update方法。

为了lucene索引使用，当添加的时候需要把添加的博客添加到blogIndex中，修改时也需要更新blogIndex.

最后把结果转化为json格式写入到response中。

**2 查询博客 list**

根据前台传入的翻页参数（查询第几页和每页显示的条数）调用blogService的list方法查询博客列表。

同时调用getTotal方法查询博客数量，最后把列表转化为json格式写入到response中。

**3 根据主键查询 findById**

根据传入的博客id查询，直接调用blogService的findById方法查询，最后把结果转化为json格式写入到response中。

**4 删除博客 delete**

前台传入的是要删除博客的id数组，遍历id数组进行删除。

针对每条博客，调用blogService的delete方法进行删除，同时需要删除索引中的值。

将结果转为json并写入response中。

### 5.6 博客编辑界面-writeBlog.jsp

首先引入jquery的css和js资源，引入ueditor编辑器。

界面主要分为以下几部分：

- 输入博客标题
- 下拉菜单选择博客类型（从applicationContext中直接取得）
- 使用ueditor编辑器输入博客内容
- 输入关键字

主要功能就是提交输入的博客，首先判断是否为空，然后调用BlogAdminController的sava方法保存博客，前台根据保存的结果显示提示信息。

注意：这里的博客内容保存的是contentNoTag，是去除html标签之后的纯文本内容。

### 5.7 博客信息管理-blogManager.jsp

首先引入jquery的css和js资源。

界面主要分为以下几部分：

- 显示博客列表，显示博客的id、标题、发布日期和所属博客类别。
- 提供搜索框搜索标题
- 修改和删除按钮

**1 查询**

当进入博客管理界面就进行查询并显示出来，调用的是BlogAdminController中的list方法。

**2 修改**

点击修改按钮之后跳转到modifyBlog.jsp页面，该页面和writeBlog.jsp页面一样，不同的是需要通过根据传入的id参数去调用BlogAdminController的findById方法去查询博客类，并填充到相应的输入框。

**3 删除**

用户选择多条类别，然后点击删除按钮。将要删除数据的id拼接成字符串作为参数，调用BlogAdminController的delete方法。

前台根据返回的值提示用户保存是否成功。

## 6 评论管理

### 6.1 评论实体类-Comment

代表数据库中的评论表，属性和数据库表保持一致，其中的所属博客是外键。

### 6.2 评论Dao-CommentDao

定义操作评论的方法：

```java
/**添加一条评论*/
public int add(Comment comment);

/**更新一条评论(这里只用来更新评论的审核状态)*/
public int update(Comment comment);

/**评论查询*/
public List<Comment> list(Map<String,Object> map);

/**评论数量*/
public Long getTotal(Map<String,Object> map);

/**删除评论*/
public Integer delete(Integer id);

/**根据博客id删除评论*/
public Integer deleteByBlogId(Integer blogId);
```

### 6.3 评论Mapper-CommentMapper

采用注解的方式配置dao的方法，在mapper中定义要执行的sql语句。

注意：list方法根据传入的参数，可以按照评论所属博客ID查询，也可以按照审核的状态查询。

### 6.4 评论Service-CommentService

定义CommentService接口以及实现类CommentServiceImpl

在实现类中添加dao层的引用commentDao，并使用注解赋值。

方法和commentDao保持一致，并且直接调用commentDao中的相应方法即可。

### 6.5 评论Controller-CommentAdminController

controller中添加service层的引用commentService。

**1 查询 list**

根据前台传入的翻页参数（查询第几页和每页显示的条数）以及审核状态调用commentService的list方法查询评论。

同时调用getTotal方法查询评论数量，最后把列表转化为json格式写入到response中。

**2 删除评论 delete**

前台传入的是要删除评论的id数组，遍历id数组进行删除。

针对每条评论，调用commentService的delete方法进行删除.

将结果转为json并写入response中。

**3 审核评论 review**

前台传入要审核的评论id数组，以及要更新的状态（通过/不通过）,然后调用commentService的update方法更新评论。

将结果转为json并写入response中。

### 6.6 评论管理界面-commentManager.jsp

首先引入jquery的css和js资源。

界面主要分为以下几部分：

- 显示评论列表，显示评论的编号、博客标题、用户IP、评论内容、评论日期和评论状态。
- 删除按钮

**1 查询**

其中所属博客标题需要通过评论的所属博客id属性，需要先查询出博客标题再显示。

同时评论的审核状态是数字代表的，需要根据不同的值显示相应的文本。

**2 删除**

选作多条评论，点击删除按钮，调用CommentAdminController的delete方法删除评论。根据返回的结果显示提示信息。

### 6.7 评论审核界面-commentReview.jsp

要显示的评论的相关内容，首先先调用CommentAdminController的list方法传入审核状态为未审核的参数，列出所有的还未审核的评论。

提供审核通过和不通过的两个操作，点击后调用CommentAdminController的review方法，同时传入要更新的状态。根据结果提示用户信息。

## 7 修改个人信息

### 7.1 博主Dao-BloggerDao

定义操作博主的方法：

```java
/**根据登录名查询博主对象*/
public Blogger getByUserName(@Param("userName")String userName);

/**更新博主对象*/
public Integer update(Blogger blogger);

/**查询博主*/
public Blogger find();
```

### 7.2 博主Mapper-BloggerMapper

采用注解的方式配置dao的方法，在mapper中定义要执行的sql语句。

注意：update方法判断是否有参数来编写SQL语句。

### 7.3 博主Service-BloggerService

定义BloggerService接口以及实现类BloggerServiceImpl

在实现类中添加dao层的引用bloggerDao，并使用注解赋值。

方法和bloggerDao保持一致，并且直接调用bloggerDao中的相应方法即可。

注意：更新博主信息之后要更新session中保存的当前用户。

### 7.4 博主Controller-BloggerAdminController

controller中添加service层的引用bloggerService。

**1 保存**

根据前台传入的参数构成的blogger类，调用bloggerService的update方法更新博主对象。

注意：博主头像保存的是头像名称。

**2 获取博主的json格式**

从session中取出博主类，转化成json格式。

**3 修改密码**

调用bloggerService的update方法更新博主的密码。

**4 用户退出**

使用shiro的logout退出，并跳转到login.jsp登陆界面。

### 7.5 修改个人信息界面-modifyInfo.jsp

提供博主类型的属性修改，用户名显示但不可修改，昵称、个性签名、个人头像、个人简介使用ueditor

从session中取出当前登陆的博主的blogger实体类，然后把信息填充到输入框中。

提交信息后调用BloggerAdminController中的sava方法保存博主信息。

## 8 友情链接

### 8.1 链接实体类-Link

代表数据库中的链接表，属性和数据库表保持一致。

### 8.2 链接Dao-LinkDao

```java
/**根据id查询一条友情链接*/
public Link findById(Integer id);

/**不固定参数查询友情链接列表*/
public List<Link> list(Map<String,Object> paramMap);

/**不固定参数查询友情链接数*/
public Long getTotal(Map<String,Object> paramMap);

/**添加一条友情链接*/
public Integer add(Link link);

/**修改一条友情链接*/
public Integer update(Link link);

/**删除一条友情链接*/
public Integer delete(Integer id);	
```

### 8.3 链接Mapper-LinkMapper

采用注解的方式配置dao的方法，在mapper中定义要执行的sql语句。

### 8.4 链接Service-LinkService

定义LinkService接口以及实现类LinkServiceImpl

在实现类中添加dao层的引用linkDao，并使用注解赋值。

方法和linkDao保持一致，并且直接调用linkDao中的相应方法即可。

### 8.5 链接Controller-LinkAdminController

controller中添加service层的引用linkService。

**1 查询 list**

根据前台传入的翻页参数（查询第几页和每页显示的条数）调用linkService的list方法查询评论。

同时调用getTotal方法查询链接数量，最后把列表转化为json格式写入到response中。

**2 保存 save**

根据传入的link是否具有id代表添加或者更新，当没有id时代表添加操作，调用linkService的add方法。

当有id时代表修改操作，调用linkService的update方法。

最后把结果转化为json格式写入到response中。

**3 删除 delete**

前台传入的是要删除链接的id数组，遍历id数组进行删除。

针对每条评论，调用linkService的delete方法进行删除.

将结果转为json并写入response中。

### 8.6 链接管理界面-LinkManage.jsp

首先引入jquery的css和js资源。

界面主要分为以下几部分：

- 显示链接列表，显示链接的编号、名称、地址和排序。
- 删除按钮

**1 查询**

当进入链接管理界面就进行查询并显示出来，调用的是LinkAdminController中的list方法。

**2 添加**

点击添加按钮，首先弹出链接信息对话框，要求输入链接名称、链接地址和序号。

点击保存按钮会调用LinkAdminController的save方法进行插入。同时会返回是否成功的信息。

前台根据返回的值提示用户保存是否成功。

**3 修改**

首先点击一条要修改的数据，然后点击修改按钮，弹出和添加一样的对话框，只不过输入框中填充好了点击的那条数据的信息，在此基础上修改，同样调用的是LinkAdminController的save方法，但是传递id参数代表修改。

前台根据返回的值提示用户保存是否成功。

**4 删除**

用户选择多条类别，然后点击删除按钮。将要删除数据的id拼接成字符串作为参数，调用LinkAdminController的delete方法。

前台根据返回的值提示用户保存是否成功。

## 9 首页前端

### 9.1 整体框架

首页主要分为

head.jsp页面显示顶部的大标题和当地天气，

meun.jsp用于显示菜单栏，包括首页按钮、关于博主、登陆后台以及搜索框。

右侧显示博主信息、按日志类别分类、按照日期分类以及友情链接。

中间显示主内容框，用于显示博客内容。

### 9.2 最新博客列表

通过IndexController控制。持有blogService的引用。其中的index方法是前台网站的入口。

根据前台传入的分页参数，调用blogService的list方法查询。

同时首页右下角有按照日志类别分类和按照日期分类，也是通过这个方法。

将查询的结果返回给前端界面，指定mainPage要跳转的页面是list.jsp页面。

list.jsp页面用于显示博客信息列表，并提供翻页按钮功能。

### 9.3 首页博主信息

首页右侧的博主信息、按日志类别、按日志日期以及友情链接资源都不需要经常更新的资源，每次加载都查询数据库造成资源浪费，所以采用存入ServletContext的方法需要的时候直接获取。

在InitComponent类中进行初始化，服务器启动的时候将博客类别信息、博主信息、按年月分类的博客数量以及友情链接存入。当后台更新这些数据后，需要手动执行刷新系统缓存操作，更新ServletContext中的内容，保证其中的信息是最新的。

在首页中就可以直接取得博主信息、按日志类别分类、按日志日期分类以及友情链接。

### 9.4 翻页功能

添加工具类PageUtil用于实现查询结果列表的分页显示和翻页功能。

### 9.5 博客详细信息

首先编写博客页面view,jsp。其中显示的信息有：

- 博客标题
- 分享按钮
- 博客信息（发表时间、 博客类别、阅读量、评论数）
- 博客内容
- 关键字
- 上一篇/下一篇
- 显示评论
- 发表评论

**1 博客详细页加载**

在博客列表中点击可以跳转到详细信息页面，通过调用BlogController中的details方法并传入博客的id值。

感觉插入的博客id调用blogService的findById方法查询博客，传递给前台。然后把阅读数加一，同时调用commmentService的list方法查询对应的评论传递给前台，

**2 添加评论**

调用commentAdminController中的save方法添加评论。

同时发布评论需要输入验证码，通过image.jsp页面生成的，并把验证码的值放入了session中。

添加评论的时候需要判断验证码是否一致。

## 10 lucene索引

### 10.1 创建lucene

添加获取lucene的方法以及增加、更新、删除和查询索引的方法。

### 10.2 创建Controller-BlogController

添加q方法用于根据搜索词查询博客，是通过lucene建立的索引，然后将查询结果显示到mainPage部分中。

